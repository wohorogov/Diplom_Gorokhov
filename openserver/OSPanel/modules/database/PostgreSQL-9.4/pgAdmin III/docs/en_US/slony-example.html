<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=cp1252" />
    
    <title>Slony-I example</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="top" title="pgAdmin III 1.20.0 documentation" href="index.html" />
    <link rel="up" title="Slony-I support" href="slony.html" />
    <link rel="next" title="Extended features" href="extend.html" />
    <link rel="prev" title="Slony-I tasks" href="slony-functions.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="extend.html" title="Extended features"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="slony-functions.html" title="Slony-I tasks"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pgAdmin III 1.20.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="slony.html" accesskey="U">Slony-I support</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="slony-i-example">
<span id="slony-example"></span><h1><span class="target" id="index-0"></span>Slony-I example</h1>
<p>In this example, a master server is setup with two direct slaves. This example was
written and tested using Slony-I v1.2.11 and PostgreSQL 8.2.5, running on a single
Windows XP machine. The PostgresSQL pgbench utility is used to generate the test
schema and workload.</p>
<ol class="arabic">
<li><p class="first">Create 3 databases, master, slave1 and slave2 and ensure pl/pgsql is
setup in each.</p>
</li>
<li><p class="first">Create a pgbench schema in the master database:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">pgbench</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">U</span> <span class="n">postgres</span> <span class="n">master</span>
</pre></div>
</div>
</li>
<li><p class="first">Add a primary key called history_pkey to the history table on the tid,
bid and aid columns</p>
</li>
<li><p class="first">Create a schema-only dump of the master database, and load it into
slave1 and slave2:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">pg_dump</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">U</span> <span class="n">postgres</span> <span class="n">master</span> <span class="o">&gt;</span> <span class="n">schema</span><span class="o">.</span><span class="n">sql</span>
<span class="o">&gt;</span> <span class="n">psql</span> <span class="o">-</span><span class="n">U</span> <span class="n">postgres</span> <span class="n">slave1</span> <span class="o">&lt;</span> <span class="n">schema</span><span class="o">.</span><span class="n">sql</span>
<span class="o">&gt;</span> <span class="n">psql</span> <span class="o">-</span><span class="n">U</span> <span class="n">postgres</span> <span class="n">slave2</span> <span class="o">&lt;</span> <span class="n">schema</span><span class="o">.</span><span class="n">sql</span>
</pre></div>
</div>
</li>
<li><p class="first">Create Slony config files for each slon engine (daemon on Unix). The
files should contain just the following two lines:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cluster_name</span><span class="o">=</span><span class="s1">&#39;pgbench&#39;</span>
<span class="n">conn_info</span><span class="o">=</span><span class="s1">&#39;host=127.0.0.1 port=5432 user=postgres dbname=master&#39;</span>
</pre></div>
</div>
<p>Create a file for each database, adjusting the dbname parameter as
required and adding any other connection options that may be
needed.</p>
</li>
<li><p class="first">(Windows only) Install the Slony-I service:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">slon</span> <span class="o">-</span><span class="n">regservice</span> <span class="n">Slony</span><span class="o">-</span><span class="n">I</span>
</pre></div>
</div>
</li>
<li><p class="first">Register each of the engines (this is only necessary on Windows - on
Unix the slon daemons may be started individually and given the path
to the config file on the command line using the -f option):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">slon</span> <span class="o">-</span><span class="n">addengine</span> <span class="n">Slony</span><span class="o">-</span><span class="n">I</span> <span class="n">C</span><span class="p">:</span>\<span class="n">slony</span>\<span class="n">master</span><span class="o">.</span><span class="n">conf</span>
<span class="o">&gt;</span> <span class="n">slon</span> <span class="o">-</span><span class="n">addengine</span> <span class="n">Slony</span><span class="o">-</span><span class="n">I</span> <span class="n">C</span><span class="p">:</span>\<span class="n">slony</span>\<span class="n">slave1</span><span class="o">.</span><span class="n">conf</span>
<span class="o">&gt;</span> <span class="n">slon</span> <span class="o">-</span><span class="n">addengine</span> <span class="n">Slony</span><span class="o">-</span><span class="n">I</span> <span class="n">C</span><span class="p">:</span>\<span class="n">slony</span>\<span class="n">slave2</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</li>
<li><p class="first">In pgAdmin under the Slony Replication node in the master database,
create a new Slony-I cluster using the following options:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Join</span> <span class="n">existing</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">Unchecked</span>
<span class="n">Cluster</span> <span class="n">name</span><span class="p">:</span>          <span class="n">pgbench</span>
<span class="n">Local</span> <span class="n">node</span><span class="p">:</span>            <span class="mi">1</span>        <span class="n">Master</span> <span class="n">node</span>
<span class="n">Admin</span> <span class="n">node</span><span class="p">:</span>            <span class="mi">99</span>       <span class="n">Admin</span> <span class="n">node</span>
</pre></div>
</div>
</li>
<li><p class="first">Under the Slony Replication node, create a Slony-I cluster in each of
the slave databases using the following options:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Join</span> <span class="n">existing</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">Checked</span>
<span class="n">Server</span><span class="p">:</span>                <span class="o">&lt;</span><span class="n">Select</span> <span class="n">the</span> <span class="n">server</span> <span class="n">containing</span> <span class="n">the</span> <span class="n">master</span> <span class="n">database</span><span class="o">&gt;</span>
<span class="n">Database</span><span class="p">:</span>              <span class="n">master</span>
<span class="n">Cluster</span> <span class="n">name</span><span class="p">:</span>          <span class="n">pgbench</span>
<span class="n">Local</span> <span class="n">node</span><span class="p">:</span>            <span class="mi">10</span>       <span class="n">Slave</span> <span class="n">node</span> <span class="mi">1</span>
<span class="n">Admin</span> <span class="n">node</span><span class="p">:</span>            <span class="mi">99</span> <span class="o">-</span> <span class="n">Admin</span> <span class="n">node</span>

<span class="n">Join</span> <span class="n">existing</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">Checked</span>
<span class="n">Server</span><span class="p">:</span>                <span class="o">&lt;</span><span class="n">Select</span> <span class="n">the</span> <span class="n">server</span> <span class="n">containing</span> <span class="n">the</span> <span class="n">master</span> <span class="n">database</span><span class="o">&gt;</span>
<span class="n">Database</span><span class="p">:</span>              <span class="n">master</span>
<span class="n">Cluster</span> <span class="n">name</span><span class="p">:</span>          <span class="n">pgbench</span>
<span class="n">Local</span> <span class="n">node</span><span class="p">:</span>            <span class="mi">20</span>       <span class="n">Slave</span> <span class="n">node</span> <span class="mi">2</span>
<span class="n">Admin</span> <span class="n">node</span><span class="p">:</span>            <span class="mi">99</span> <span class="o">-</span> <span class="n">Admin</span> <span class="n">node</span>
</pre></div>
</div>
</li>
<li><p class="first">Create Paths on the master to both slaves, and on each slave back to
the master. Create the paths under each node on the master, using the
connection strings specified in the slon config files. Note that future
restructuring of the cluster may require additional paths to be defined.</p>
</li>
<li><p class="first">Create a Replication Set on the master using the following settings:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ID</span><span class="p">:</span>                  <span class="mi">1</span>
<span class="n">Comment</span><span class="p">:</span>             <span class="n">pgbench</span> <span class="nb">set</span>
</pre></div>
</div>
</li>
<li><p class="first">Add the tables to the replication set using the following settings:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="p">:</span>               <span class="n">public</span><span class="o">.</span><span class="n">accounts</span>
<span class="n">ID</span><span class="p">:</span>                  <span class="mi">1</span>
<span class="n">Index</span><span class="p">:</span>               <span class="n">accounts_pkey</span>

<span class="n">Table</span><span class="p">:</span>               <span class="n">public</span><span class="o">.</span><span class="n">branches</span>
<span class="n">ID</span><span class="p">:</span>                  <span class="mi">2</span>
<span class="n">Index</span><span class="p">:</span>               <span class="n">branches_pkey</span>

<span class="n">Table</span><span class="p">:</span>               <span class="n">public</span><span class="o">.</span><span class="n">history</span>
<span class="n">ID</span><span class="p">:</span>                  <span class="mi">3</span>
<span class="n">Index</span><span class="p">:</span>               <span class="n">history_pkey</span>

<span class="n">Table</span><span class="p">:</span>               <span class="n">public</span><span class="o">.</span><span class="n">tellers</span>
<span class="n">ID</span><span class="p">:</span>                  <span class="mi">4</span>
<span class="n">Index</span><span class="p">:</span>               <span class="n">tellers_pkey</span>
</pre></div>
</div>
</li>
<li><p class="first">On the master node, create a new subscription for each slave using the
following options:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Origin</span><span class="p">:</span>              <span class="mi">1</span>
<span class="n">Provider</span><span class="p">:</span>            <span class="mi">1</span> <span class="o">-</span> <span class="n">Master</span> <span class="n">node</span>
<span class="n">Receiver</span><span class="p">:</span>            <span class="mi">10</span> <span class="o">-</span> <span class="n">Slave</span> <span class="n">node</span> <span class="mi">1</span>

<span class="n">Origin</span><span class="p">:</span>              <span class="mi">1</span>
<span class="n">Provider</span><span class="p">:</span>            <span class="mi">1</span> <span class="o">-</span> <span class="n">Master</span> <span class="n">node</span>
<span class="n">Receiver</span><span class="p">:</span>            <span class="mi">20</span> <span class="o">-</span> <span class="n">Slave</span> <span class="n">node</span> <span class="mi">2</span>
</pre></div>
</div>
</li>
<li><p class="first">Start the slon service (or daemons on Unix):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">net</span> <span class="n">start</span> <span class="n">Slony</span><span class="o">-</span><span class="n">I</span>
</pre></div>
</div>
</li>
</ol>
<p>Initial replication should begin and can be monitored on the statistics
tab in pgAdmin for each node. The pgbench utility may be run against the
master database to generate a test workload.</p>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="extend.html" title="Extended features"
             >next</a> |</li>
        <li class="right" >
          <a href="slony-functions.html" title="Slony-I tasks"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pgAdmin III 1.20.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="slony.html" >Slony-I support</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2002 - 2014, The pgAdmin Development Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
  </body>
</html>